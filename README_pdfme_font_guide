# ğŸ“„ HÆ°á»›ng dáº«n sá»­ dá»¥ng pdfme vá»›i Font tiáº¿ng Nháº­t

## ğŸ¯ Má»¥c Ä‘Ã­ch
TÃ i liá»‡u nÃ y hÆ°á»›ng dáº«n cÃ¡ch sá»­ dá»¥ng library `@pdfme/generator` Ä‘á»ƒ táº¡o PDF há»— trá»£ tiáº¿ng Nháº­t mÃ  khÃ´ng gáº·p lá»—i encoding nhÆ° "WinAnsi cannot encode".

## âŒ Váº¥n Ä‘á» thÆ°á»ng gáº·p

### Lá»—i WinAnsi Encoding:
```
PDF generation failed: Error: WinAnsi cannot encode "ã“" (0x3053)
    at Encoding2.encodeUnicodeCodePoint
    at StandardFontEmbedder.encodeTextAsGlyphs
```

### NguyÃªn nhÃ¢n:
- Font khÃ´ng Ä‘Æ°á»£c load Ä‘Ãºng cÃ¡ch
- pdfme fallback vá» font máº·c Ä‘á»‹nh vá»›i encoding WinAnsi
- WinAnsi khÃ´ng há»— trá»£ kÃ½ tá»± Unicode nhÆ° tiáº¿ng Nháº­t

## âœ… Giáº£i phÃ¡p Ä‘Ãºng

### 1. Cáº¥u trÃºc thÆ° má»¥c
```
public/
â”œâ”€â”€ fonts/
â”‚   â””â”€â”€ NotoSansJP-Regular.ttf  (9.1MB)
â””â”€â”€ ...
```

### 2. Code implementation Ä‘Ãºng

```typescript
import type { Template } from '@pdfme/common';
import { generate } from '@pdfme/generator';

// âœ… ÄÃšNG: Load font vÃ  return Uint8Array
async function loadFont() {
  const res = await fetch('/fonts/NotoSansJP-Regular.ttf');
  const buffer = await res.arrayBuffer();
  return new Uint8Array(buffer);  // Chá»‰ return data thÃ´i
}

export function useFileDownloader() {
  async function generateSimplePdf() {
    // Load font data
    const fontData = await loadFont();

    // Template configuration
    const template: Template = {
      basePdf: {
        width: 210,
        height: 297,
        padding: [10, 10, 10, 10] as [number, number, number, number],
      },
      schemas: [
        [{
          name: 'title',
          type: 'text',
          position: { x: 10, y: 15 },
          width: 190,
          height: 12,
          fontSize: 18,
          fontName: 'NotoSansJP',  // TÃªn font
          alignment: 'center',
        }],
      ],
      // âš ï¸ KHÃ”NG Ä‘Æ°a fonts vÃ o Ä‘Ã¢y
    };

    try {
      // âœ… QUAN TRá»ŒNG: Font pháº£i á»Ÿ trong options.font
      const pdf = await generate({
        template,
        inputs: [{
          title: 'Japanese: ã“ã‚“ã«ã¡ã¯ ğŸŒ',
        }],
        options: {
          font: {
            NotoSansJP: {
              data: fontData,    // Font data tá»« local
              fallback: true,    // Fallback náº¿u cáº§n
            },
          },
        },
      });

      // Download PDF
      const blob = new Blob([pdf.buffer], { type: 'application/pdf' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `document-${Date.now()}.pdf`;
      link.click();
      URL.revokeObjectURL(url);

      console.log('âœ… PDF generated successfully!');
    } catch (error) {
      console.error('âŒ PDF generation failed:', error);
      console.error('Lá»—i táº¡o PDF. Kiá»ƒm tra console Ä‘á»ƒ biáº¿t chi tiáº¿t.');
    }
  }

  return { generateSimplePdf };
}
```

## ğŸ”„ So sÃ¡nh cÃ¡ch lÃ m SAI vs ÄÃšNG

### âŒ SAI (gÃ¢y lá»—i WinAnsi):

```typescript
// SAI: Return object phá»©c táº¡p
async function loadFont() {
  return {
    name: 'NotoSansJP',
    data: new Uint8Array(buffer),
    fallback: true,
    subset: false,  // Metadata khÃ´ng cáº§n thiáº¿t
  };
}

// SAI: ÄÆ°a font vÃ o template.fonts
const template = {
  // ...
  fonts: {
    NotoSansJP: font,  // âŒ Sai chá»— nÃ y
  },
};

// SAI: KhÃ´ng cÃ³ options.font
const pdf = await generate({
  template,
  inputs,
  // Thiáº¿u options.font
});
```

### âœ… ÄÃšNG (hoáº¡t Ä‘á»™ng tá»‘t):

```typescript
// ÄÃšNG: Chá»‰ return Uint8Array
async function loadFont() {
  const res = await fetch('/fonts/NotoSansJP-Regular.ttf');
  const buffer = await res.arrayBuffer();
  return new Uint8Array(buffer);  // ÄÆ¡n giáº£n
}

// ÄÃšNG: Template khÃ´ng cÃ³ fonts
const template = {
  basePdf: { ... },
  schemas: [ ... ],
  // KhÃ´ng cÃ³ fonts á»Ÿ Ä‘Ã¢y
};

// ÄÃšNG: Font á»Ÿ trong options
const pdf = await generate({
  template,
  inputs,
  options: {
    font: {
      NotoSansJP: {
        data: fontData,    // âœ… ÄÃºng chá»— nÃ y
        fallback: true,
      },
    },
  },
});
```

## ğŸŒ VÃ­ dá»¥ vá»›i ná»™i dung tiáº¿ng Nháº­t

```typescript
const inputs = [
  {
    title: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«',
    content: `
      ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå: Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™º
      æ‹…å½“è€…: ç”°ä¸­å¤ªéƒ
      æœŸé–“: 2024å¹´1æœˆã€œ3æœˆ
      
      ä½œæ¥­å†…å®¹:
      â€¢ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™º
      â€¢ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™º  
      â€¢ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      
      å‚™è€ƒ: æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆå¯¾å¿œPDFç”Ÿæˆ
    `,
    footer: 'æ³¨è¨˜: pdfme ã«ã‚ˆã‚‹æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆå¯¾å¿œ',
  },
];
```

## ğŸ› ï¸ Troubleshooting

### Lá»—i 404 khi load font:
```
Failed to fetch font: 404 Not Found
```
**Giáº£i phÃ¡p:** Kiá»ƒm tra file `NotoSansJP-Regular.ttf` cÃ³ tá»“n táº¡i trong `public/fonts/`

### Lá»—i CORS:
```
Access to fetch blocked by CORS policy
```
**Giáº£i phÃ¡p:** Äáº£m báº£o font file Ä‘Æ°á»£c serve tá»« cÃ¹ng domain

### Font khÃ´ng hiá»ƒn thá»‹:
- Kiá»ƒm tra `fontName: 'NotoSansJP'` trong schema
- Äáº£m báº£o tÃªn font match vá»›i key trong `options.font`

## ğŸ“Š Performance Notes

- **Font size**: NotoSansJP-Regular.ttf ~ 9.1MB
- **Load time**: ~1-2s tÃ¹y connection
- **Recommendation**: Cache font data náº¿u táº¡o nhiá»u PDF

## ğŸ”„ Migration tá»« CDN sang Local

Náº¿u Ä‘ang dÃ¹ng CDN font:

```typescript
// CDN (cÅ©)
options: {
  font: {
    NotoSansJP: {
      data: 'https://fonts.gstatic.com/s/notosansjp/...',
      fallback: true,
    },
  },
}

// Local (má»›i)
const fontData = await loadFont();
options: {
  font: {
    NotoSansJP: {
      data: fontData,  // Uint8Array tá»« local file
      fallback: true,
    },
  },
}
```

## ğŸ“ Checklist

- [ ] Font file `NotoSansJP-Regular.ttf` trong `public/fonts/`
- [ ] `loadFont()` return `Uint8Array`
- [ ] Font config trong `options.font`, KHÃ”NG trong `template.fonts`
- [ ] `fontName: 'NotoSansJP'` trong schema elements
- [ ] Test vá»›i kÃ½ tá»± tiáº¿ng Nháº­t: ã²ã‚‰ãŒãª, ã‚«ã‚¿ã‚«ãƒŠ, æ¼¢å­—
- [ ] Error handling vá»›i `console.error()` thay vÃ¬ `alert()`

---

ğŸ¯ **Káº¿t quáº£**: PDF há»— trá»£ hoÃ n toÃ n tiáº¿ng Nháº­t mÃ  khÃ´ng gáº·p lá»—i WinAnsi encoding! 
